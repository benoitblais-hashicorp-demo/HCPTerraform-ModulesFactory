name: Provision Module

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      name:
        description: 'Name of the module to create.'
        required: true
        type: string
      provider:
        description: 'The main provider the module uses'
        required: true
        type: choice
        options:
          - 'aws'
          - 'azuread'
          - 'azurerm'
          - 'github'
          - 'hcp'
          - 'local'
          - 'null'
          - 'random'
          - 'terraform'
          - 'tfe'
          - 'time'
          - 'tls'
      no-code:
        description: 'Whether it is a no-code module or not.'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: read

jobs:
  build:
    name: Provision Module
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TFC_API_TOKEN: ${{ secrets.TFE_TOKEN }}
      TFC_ORGANIZATION: "benoitblais-hashicorp"
      TFC_PROJECT: "Terraform Modules Factory"
      TFC_MODULE_NAME: "modulesfactory"
      TFC_MODULE_PROVIDER: "tfe"
    steps:

      - name: Retreive no-code module ID
        id: get_no_code_module_id
        run: |
          echo "INFO     | Build required variables."
          tfc_api_url="https://app.terraform.io/api/v2"
          auth_header="Authorization: Bearer ${TFC_API_TOKEN}"
          content_header="Content-Type: application/vnd.api+json"
          echo "INFO     | Get module information."
          {
            run=$(curl -sS --request GET --url "${tfc_api_url}/organizations/${TFC_ORGANIZATION}/registry-modules/private/${TFC_ORGANIZATION}/${TFC_MODULE_NAME}/${TFC_MODULE_PROVIDER}" \
            --header "${auth_header}" --header "${content_header}")
            if ! [[ "${run}" =~ "{\"data\":" ]]; then
              echo "ERROR    | Unable to to get module information."
              echo "${run}"
              exit 1
            fi
          } ||
          {
            echo "ERROR    | An error occurred during the API call to get module information."
            exit 1
          }
          no_code_id=$(echo "${run}" | jq -r '.data.relationships."no-code-modules".data[].id')
          if [ -z "${no_code_id}" ] || [ "${no_code_id}" == "null" ]; then
            echo "ERROR    | Unable to find no-code module ID."
            exit 1
          else
            echo "INFO     | No-code module ID is ${no_code_id}."
            echo "NO_CODE_ID=${no_code_id}" >> "$GITHUB_ENV"
          fi

      - name: Retreive HCP Terraform Project ID
        id: get_project_id
        run: |
          echo "INFO     | Build required variables."
          tfc_api_url="https://app.terraform.io/api/v2"
          auth_header="Authorization: Bearer ${TFC_API_TOKEN}"
          content_header="Content-Type: application/vnd.api+json"
          echo "INFO     | Run API call to get project list."
          {
            run=$(curl -sS --request GET --url "${tfc_api_url}/organizations/${TFC_ORGANIZATION}/projects" \
            --header "${auth_header}" --header "${content_header}")
            if ! [[ "${run}" =~ "{\"data\":" ]]; then
              echo "ERROR    | Unable to get project list."
              echo "${run}"
              exit 1
            fi
          } ||
          {
            echo "ERROR    | An error occurred during the API call to get project list."
            exit 1
          }
          project_id=$(echo "${run}" | jq -r '.data[] | select(.attributes.name=="'"${TFC_PROJECT}"'") | .id')
          if [ -z "${project_id}" ] || [ "${project_id}" == "null" ]; then
            echo "ERROR    | Unable to find project ID."
            exit 1
          else
            echo "INFO     | Project ID is ${project_id}."
            echo "project_id=${project_id}" >> "$GITHUB_ENV"
          fi

      - name: Provision Module
        env:
          PROVIDER: ${{ github.event.inputs.provider }}
          NAME: ${{ github.event.inputs.name }}
          NO_CODE_ID: ${{ steps.get_no_code_module_id.outputs.NO_CODE_ID }}
          PROJECT_ID: ${{ steps.get_project_id.outputs.project_id }}
          NO_CODE: ${{ github.event.inputs.no-code }}
        run: |
          echo "INFO     | Build required variables."
          tfc_api_url="https://app.terraform.io/api/v2"
          auth_header="Authorization: Bearer ${TFC_API_TOKEN}"
          content_header="Content-Type: application/vnd.api+json"
          workspace_name="terraform-${PROVIDER}-${NAME}"
          echo "INFO     | Creating workspace ${workspace_name} in project ${TFC_PROJECT}."
          if [ "${NO_CODE}" = true ] ; then
            no_code='{"type":"vars","attributes":{"key":"no_code_module","value":"true","category":"terraform"}}'
          else
            no_code='{"type":"vars","attributes":{"key":"no_code_module","value":"false","category":"terraform"}}'
          fi
          json_string='{"data":{"type":"workspaces","attributes":{"name":"'"${workspace_name}"'","auto_apply":true},"relationships":{"project":{"data":{"id":"'"${PROJECT_ID}"'","type":"project"}},"vars":{"data":[{"type":"vars","attributes":{"key":"module_name","value":"'"${NAME}"'","category":"terraform"}},{"type":"vars","attributes":{"key":"module_provider","value":"'"${PROVIDER}"'","category":"terraform"}},'"${no_code}"']}}}}'
          json_payload=$(echo "${json_string}" | jq)
          echo "$json_payload"
          run=$(curl -sS --request POST --url "${tfc_api_url}/no-code-modules/$NO_CODE_ID}/workspaces" \
          --header "${auth_header}" --header "${content_header}" --data "${json_payload}")
          if ! [[ "${run}" =~ "{\"data\":" ]]; then
            echo "ERROR    | Unable to create workspace."
            echo "${run}"
            exit 1
          else
            echo "INFO     | Workspace created successfully."
            echo "${run}"
          fi
